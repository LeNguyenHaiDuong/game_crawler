name: Genre Crawler Batch

on:
  workflow_dispatch:  # Chạy thủ công khi bấm "Run workflow"

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Cấp quyền ghi vào repo

    strategy:
      matrix:
        batch_id: [0, 1, 2, 3, 4, 5, 6]  # Chạy 7 workflow song song

    steps:
      - name: Check Memory Usage
        run: free -h

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run genre.py for Batch ${{ matrix.batch_id }}
        run: python -u genre.py ${{ matrix.batch_id }} || echo "Script failed, check logs."

      - name: Upload CSV Progress
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vgsales-progress-batch-${{ matrix.batch_id }}
          path: vgsales_updated_${{ matrix.batch_id }}.csv

      - name: Save progress to GitHub
        if: always()
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          
          FILE_PATH="data/vgsales_updated_${{ matrix.batch_id }}.csv"
          
          # Kiểm tra xem file có tồn tại không trước khi add vào Git
          if [ -f "$FILE_PATH" ]; then
            git add "$FILE_PATH"
            git commit -m "Batch ${{ matrix.batch_id }} progress"
            git push origin master
          else
            echo "⚠️ No file found at $FILE_PATH, skipping commit."
          fi
